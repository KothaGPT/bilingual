name: Wikipedia LM Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/*wiki*.py'
      - 'src/bilingual/modules/wikipedia_lm.py'
      - 'tests/wikipedia/**'
      - '.github/workflows/test_wikipedia.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/*wiki*.py'
      - 'src/bilingual/modules/wikipedia_lm.py'
      - 'tests/wikipedia/**'
      - '.github/workflows/test_wikipedia.yml'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-timeout
    
    - name: Install package
      run: |
        pip install -e .
    
    - name: Run Wikipedia tests
      run: |
        pytest tests/wikipedia/ -v --cov=src/bilingual/modules/wikipedia_lm --cov=scripts --cov-report=xml --cov-report=term-missing --timeout=300
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: wikipedia
        name: wikipedia-tests
        fail_ci_if_error: false
    
    - name: Generate coverage report
      if: always()
      run: |
        coverage report
        coverage html
    
    - name: Upload coverage HTML
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html-${{ matrix.python-version }}
        path: htmlcov/

  test-slow:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-timeout
    
    - name: Install package
      run: |
        pip install -e .
    
    - name: Run slow tests
      run: |
        pytest tests/wikipedia/ -v -m slow --timeout=600

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
    
    - name: Run flake8
      run: |
        flake8 scripts/*wiki*.py src/bilingual/modules/wikipedia_lm.py tests/wikipedia/ --max-line-length=120 --extend-ignore=E203,W503
    
    - name: Run black check
      run: |
        black --check scripts/*wiki*.py src/bilingual/modules/wikipedia_lm.py tests/wikipedia/
    
    - name: Run isort check
      run: |
        isort --check-only scripts/*wiki*.py src/bilingual/modules/wikipedia_lm.py tests/wikipedia/
    
    - name: Run mypy
      run: |
        mypy scripts/*wiki*.py src/bilingual/modules/wikipedia_lm.py --ignore-missing-imports || true

  integration:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install package
      run: |
        pip install -e .
    
    - name: Test preprocessing pipeline
      run: |
        # Create sample data
        mkdir -p datasets/wikipedia/test_raw
        echo "Sample Wikipedia text for testing." > datasets/wikipedia/test_raw/sample.txt
        
        # Test preprocessing script imports
        python -c "from scripts.preprocess_wiki import WikiTextCleaner; print('✓ Preprocessing imports OK')"
    
    - name: Test training script imports
      run: |
        python -c "from scripts.train_wiki_lm import WikipediaLMTrainer; print('✓ Training imports OK')"
    
    - name: Test evaluation script imports
      run: |
        python -c "from scripts.evaluate_wiki_lm import WikipediaLMEvaluator; print('✓ Evaluation imports OK')"
    
    - name: Test module imports
      run: |
        python -c "from bilingual.modules.wikipedia_lm import WikipediaLanguageModel, load_model; print('✓ Module imports OK')"
    
    - name: Test monitoring script
      run: |
        python scripts/monitor_wiki_extraction.py --json || echo "Monitor script needs dataset"
    
    - name: Test validation script
      run: |
        python scripts/validate_wiki_dataset.py --help
